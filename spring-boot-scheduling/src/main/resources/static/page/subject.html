<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
  	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>课程管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layui/css/layui.css">
</head>
<!-- 如果引入jquery.js则需要下面的不能使用  ,$=layui.jquery;否则会出现关闭弹窗后页面再次显示得到页面
<script src="../js/jquery-1.8.3.js"></script>-->
<script src="../layui/layui.js"></script>
<div id="detailsubject" style="display: none; padding: 10px">
 	<form class="layui-form" action=" ">
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">课程号</label>
				<div class="layui-input-block">
					<input type="text" class="layui-input " id="detail_subcode" name="detail_subcode" required lay-verify="required" readonly="true" >
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">名称</label>
				<div class="layui-input-block">
				<input type="text" class="layui-input " id="detail_subname" name="detail_subname" required lay-verify="required" readonly="true" >
					
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">		
				<label class="layui-form-label">学时</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="detail_subtime" name="detail_subtime" readonly="true" >
				</div>
			</div>
			<div class="layui-inline">		
				<label class="layui-form-label">学分</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="detail_subcredit" name="detail_subcredit" readonly="true" >
				</div>
					
			</div>
			<div class="layui-inline">		
				<label class="layui-form-label">课程性质</label>
				<div class="layui-input-inline">
					<select id="majortype">
						<option value="专业必修">专业必修</option>
						<option value="专业限选">专业限选</option>
						<option value="专业任选">专业任选</option>
					</select>
				</div>
					
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">开设专业</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="detail_major" name="detail_major"  readonly="true" >
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">		
				<label class="layui-form-label">发布时间</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="detail_addtime" name="detail_addtime" required lay-verify="datetime"  readonly="true" >
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">任课教师</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="detail_teacher" name="detail_teacher"  readonly="true" >
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">描述</label>
			<div class="layui-input-block">
			<textarea class="layui-textarea description" id="detail_LAY_demo1" name="description" style="display: none"  > </textarea>			
			</div>
		</div> 
	</form>
</div>
<div id="addsubject" style="display: none; padding: 10px">
 	<form class="layui-form" action=" ">
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">课程号</label>
				<div class="layui-input-block">
					<input type="text" class="layui-input " id="subcode" name="subcode" required lay-verify="required"  >
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">名称</label>
				<div class="layui-input-block">
				<input type="text" class="layui-input " id="subname" name="subname" required lay-verify="required"  >
					
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">		
				<label class="layui-form-label">学时</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="subtime" name="subtime"  >
				</div>
			</div>
			<div class="layui-inline">		
				<label class="layui-form-label">学分</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="subcredit" name="subcredit" >
				</div>
					
			</div>
			<div class="layui-inline">		
				<label class="layui-form-label">课程性质</label>
				<div class="layui-input-inline">
					<select id="majortype">
						<option value="专业必修">专业必修</option>
						<option value="专业限选">专业限选</option>
						<option value="专业任选">专业任选</option>
					</select>
				</div>
					
			</div>
		</div><div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">开设专业</label>
				<div class="layui-input-inline">
					<select id="addmajor">
						    <option value="-1"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">		
				<label class="layui-form-label">发布时间</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" id="addtime" name="addtime" required lay-verify="datetime">
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">任课教师</label>
				<div class="layui-input-inline">
					<select id="addteacher">
						    <option value="-1"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">描述</label>
			<div class="layui-input-block">
			<textarea class="layui-textarea description" id="LAY_demo1" name="description" style="display: none"  > </textarea>			
			</div>
		</div> 
	</form>
</div>  
<body>
<table class="layui-hide" id="list" lay-filter="list"></table>
<script type="text/html" id="toolbar">
<div class="layui-form-item">
	<div class="layui-inline">
	<div class="layui-btn-container">
		<button class="layui-btn layui-btn-sm " lay-event="add"><i class="layui-icon layui-icon-add-1" style="font-size: 30px;"></i>添加</button>
    	<button class="layui-btn layui-btn-sm" lay-event="delete"><i class="layui-icon layui-icon-delete" style="font-size: 30px;"></i>删除</button>
    	<button class="layui-btn layui-btn-sm" lay-event="update"><i class="layui-icon layui-icon-edit" style="font-size: 30px;"></i>编辑</button>		
	</div>
	</div>		
	<!--定义外层input-->
	<div class="layui-inline">
		    <div class="layui-input-inline">
        	    <input class="layui-input" name="roomcode" type="text" autocomplete="off" lay-verify="required">
 		    </div>
		<button class="layui-btn layui-btn-sm" lay-event="search"><i class="layui-icon layui-icon-search" style="font-size: 30px;"></i>搜索</button>
	</div>	
</div>
</script>
<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-primary layui-btn-xs"  lay-event="detail">查看</a>
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
	layui.use(['laydate', 'laypage', 'layer', 'table', 'upload', 'element', 'slider','layedit','form'], function(){
	  var laydate = layui.laydate //日期
	  ,laypage = layui.laypage //分页
	  ,layer = layui.layer //弹层
	  ,table = layui.table //表格
	  ,upload = layui.upload //上传
	  ,element = layui.element //元素操作
	  ,slider = layui.slider //滑块
	  ,layedit=layui.layedit
	  ,form=layui.form
	  ,$=layui.jquery;
	
	 	
	 //时间范围
		laydate.render({
		    elem: '#addtime'
		    ,type: 'datetime'
		  });
		
		//执行一个 table 实例
		table.render({
		  elem: '#list'
		  ,height:600 
		  ,url: '/subject/list' //数据接口
		  ,title: '时间表'
		  ,page: true //开启分页
		  ,toolbar: '#toolbar' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
		  ,totalRow: true //开启合计行
		  ,cols: [[ //表头
		    {type: 'checkbox', fixed: 'left'}
		    ,{field: 'id', title: 'ID', width:50, sort: true, fixed: 'left', }
		    ,{field: 'subcode', title: '课程号', width:120}
		    ,{field: 'subname', title: '课程名', width:150} 
		    ,{field: 'subtime', title: '学时', width: 100}
		    ,{field: 'subcredit', title: '学分', width:100} 
		    ,{field: 'subtype',title:'课程性质',width:150}
		    ,{field: 'majorno',title:'开设专业',width:120}
		    ,{field: 'subdescription', title: '课程简介', width: 200}
		    ,{field: 'teacherid', title: '任课教师', width: 100}
		    ,{field: 'addtime', title: '添加时间', width:150} 
		    ,{fixed: 'right', width: 200, align:'center', toolbar: '#barDemo'}
		  ]]
		});
		  //判断浏览器大小方法
	      function screen() {
	          //获取当前窗口的宽度
	  	    var width = $(window).width();
	  	    if (width > 1200) {
	  	        return 3;   //大屏幕
	  	    } else if (width > 992) {
	  	        return 2;   //中屏幕
	  	    } else if (width > 768) {
	  	        return 1;   //小屏幕
	  	    } else {
	  	        return 0;   //超小屏幕
	  	    }
	      }
		//监听头工具栏事件
		table.on('toolbar(list)', function(obj){
		  var checkStatus = table.checkStatus(obj.config.id)
		  ,data = checkStatus.data; //获取选中的数据; 
		  switch(obj.event){
		    case 'add':
		    	edtior_edit()
				      layer.open({
				    	  type:1,
						  title:'添加课程信息',
						  area:screen() < 2 ? ['80%', '70%'] : ['1000px', '600px'],
						  btn:['确认添加','取消'],
						  content:$("#addsubject"),
						  success:function(layreo,index){
							  //success其实就是打开这个页面(或组件)成功后调用的
							  //layer.alert("success");
							  $.ajax({
								  url:'/teacher/getteacher',
								  type:'post',
								  success:function(res){
									  if (res.code == "0") {
	                                        var $teacher = $('#addteacher');
	                                        for (var i = 0; i < res.data.length; i++) {
	                                            $teacher.append('<option value="' + res.data[i].id + '">' +res.data[i].tereoff+"--"+res.data[i].name + '</option>');
	                                        	console.log(res.data[i].name)
	                                        }
	                                        
	                                        form.render();
	                                    } else {
	                                        layer.msg(res.msg, {icon: 2, time: 1000});
	                                    }
								  },
								  error:function(res){
									  layer.alert("出现错误")
								  }
							  })
							  //
							  $.ajax({
								  url:'/depart/getDepart',
								  type:'post',
								  success:function(res){
									  if (res.code == "0") {
	                                        var $major=$('#addmajor')
	                                        for (var i = 0; i < res.data.length; i++) {
	                                        	console.log(res.data[i].depno);
	                                            $major.append('<option value="' + res.data[i].majorno + '">' + res.data[i].majorname + '</option>')
	                                        }
	                                        
	                                        form.render();
	                                    } else {
	                                        layer.msg(res.msg, {icon: 2, time: 1000});
	                                    }
								  },
								  error:function(res){
									  layer.alert("出现错误")
								  }
							  })
							  //这里是为了重新渲染一下表单，,因为这里的表单没有开关效果，
							  form.render();
						  },
				    	  yes:function(index,layero){
				    		  var subcode=$("#subcode").val();
				    		  var subname=$('#subname').val();
				    		  var subcredit=$("#subcredit").val();
				    		  var teacherid=$('#addteacher').val();
				    		  var subtime=$('#subtime').val();
				    		  var addtime=$('#addtime').val();
				    		  var subtype=$('#majortype').val();
				    		  var description=layedit.getContent(layuieditor);
				    		  var majorno=$('#addmajor').val();
				    		  //获取文本域中的内容必须要使用创建出的index的属性
					    		$.ajax({
					    			url:'/subject/add',
					    			type:'post',
					    			data:{subcode:subcode,subname:subname,subcredit:subcredit,subtype:subtype,majorno:majorno,subdescription:description,teacherid:teacherid,subtime:subtime,addtime:addtime},
					    			success:function(res){
					    				  if(res.code=='0'){
					    					  layer.alert('添加成功')
					    					  layer.close(index);
						    				  }else{
						    					  layer.alert('未能够成功添加')
						    				  }
					    				  
					    			  },
					    			error:function(res){
					    				  layer.alert('出现错误');
					    			  },
					    		  })
				    	  },
						  cancel:function(index){
							  layer.close(index);
							
						  }
				    	 
				      })
		    break;
		    case 'update':
		      if(data.length === 0){
		        layer.msg('请选择一行');
		      } else if(data.length > 1){
		        layer.msg('只能同时编辑一个');
		      } else {
		        layer.alert('编辑 [id]：'+ checkStatus.data[0].id);
		        layer.open({
		        	type:1,
		        	title:'修改学科信息',
		        	area:screen()<2?['80%','70%']:['1000px','600px'],
		        	content:$("#addteacher"),
		        	btn:['修改','取消'],
		        	//确定按钮的回调方法
		        	yes:function(index,layero){
		        		 
			    		  var id=data.id;
			    		  console.log(id)
			    		  //获取文本域中的内容必须要使用创建出的index的属性
			    		  var description=layedit.getContent(layuieditor);
			    		  	console.log(description)
			    		  var imageurl=""; 
				    		  $.ajax({
				    			  url:'/teacher/update',
				    			  type:'post',
				    			  data:{department:department,tereoff:tereoff,teachenumber:teachnumber,sex:sex,iccode:iccode,description:description,addtime:time,name:name},
				    			  success:function(res){
				    				  if(res.code=='0'){
				    					  layer.alert('添加成功')
				    					  layer.close(index);
				    					  
				    				  }else{
				    					  layer.alert('未能够成功添加')
				    				  }
				    				  
				    			  },
				    			  error:function(res){
				    				  layer.alert('出现错误');
				    			  }
				    		  })
		        	},
		        	//创建层后需要的一些回调
		        	success:function(layero,index){
		        		$.ajax({
							  url:'/teacher/getteacher',
							  type:'post',
							  success:function(res){
								  if (res.code == "0") {
                                      var $teacher = $('#addteacher');
                                      for (var i = 0; i < res.data.length; i++) {
                                          $teacher.append('<option value="' + res.data[i].id + '">' +res.data[i].tereoff+"--"+res.data[i].name + '</option>');
                                      	console.log(res.data[i].name)
                                      }
                                      
                                      form.render();
                                  } else {
                                      layer.msg(res.msg, {icon: 2, time: 1000});
                                  }
							  },
							  error:function(res){
								  layer.alert("出现错误")
							  }
						  })
						  
						  //这里是为了重新渲染一下表单，,因为这里的表单没有开关效果，
						  form.render();
		        	},
		        	cancel:function(index){
						  layer.close(index);
						
					 }
		        })
		      }
		    break;
		    case 'delete':
		      if(data.length === 0){
		        layer.msg('请选择一行');
		      } else {
		        layer.msg('删除');
		      }
		    break;
		    case 'search':
		    	layer.alert("search")
		  };
		});
		//监听行工具事件：
		table.on('tool(list)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
		    var data = obj.data //获得当前行数据
		    ,layEvent = obj.event; //获得 lay-event 对应的值
		    if(layEvent === 'detail'){
		      layer.open({
		        	type:1,
		        	title:'查看',
		        	area:screen()<2?['80%','70%']:['1000px','600px'],
		        	content:$("#detailsubject"),
		        	//创建层后需要的一些回调
		        	success:function(layero,index){
						$('#detail_addtime').val(data.addtime);
		        		layedit.setContent(data.subdescription)
		        		$('#detail_subcode').val(data.subcode);
		        		$('#detail_subname').val(data.subname);
		        		$('#detail_subcredit').val(data.subcredit);
		        		$('#detail_subtime').val(data.subtime)
		        		var majorno=data.majorno;
		        		console.log(majorno);
		        		var teacherid=data.teacherid;
		        		$.ajax({
		        			url:'/teacher/getTeacherByid',
		        			type:'post',
		        			data:{teacherid:teacherid},
		        			success:function(res){
		        				if(res.code=='0'){
		        					$('#detail_teacher').val(res.data.tereoff+"-"+res.data.name);
		        				}else{
		        					layer.alert('未能够获取到,出现错误')
		        				}
		        		
		        			},
		        			error:function(res){
		        				layer.alert('出现错诶')
		        			}
		        		});
		        		$.ajax({
		        			url:'/depart/getdepartBymajorno',
		        			type:'post',
		        			data:{majorno:majorno},
		        			success:function(res){
		        				if(res.code=='0'){
		        					$('#detail_major').val(res.data.majorname);
		        				}else{
		        					layer.alert('未能够获取到,出现错误')
		        				}
		        		
		        			},
		        			error:function(res){
		        				layer.alert('出现错诶')
		        			}
		        		})
		        		form.render();
		        	},
		        	yes:function(layero,index){
		        		
		        	},
		        	cancel:function(index){
						  layer.close(index);
						
					  }
		        })
		      
		    } else if(layEvent === 'del'){
		      layer.confirm('真的删除行么', function(index){
		        obj.del(); //删除对应行（tr）的DOM结构
		        layer.close(index);
		        //向服务端发送删除指令
		      });
		    } else if(layEvent === 'edit'){
		      layer.open({
		        	type:1,
		        	title:'修改信息',
		        	area:screen()<2?['80%','70%']:['1000px','600px'],
		        	content:$("#addsubject"),
		        	btn:['修改','取消'],
		        	//确定按钮的回调方法
		        	yes:function(index,layero){
		        		var addtime=$('.addtime').val();
			    		  var time=$('#addtime').val();
			    		  var flag=$('#flag').val();
			    		  var name=$('#name').val();
			    		  var department=$('#department').val();
			    		  var spcialty=$('#specialty').val();
			    		  //获取文本域中的内容必须要使用创建出的index的属性
			    		var description=layedit.getContent(layuieditor);
			    		  	console.log(description)
			    		var imageurl=""; 
				    	$.ajax({
				    		url:'/subject/update',
				    		type:'post',
				    		data:{floor:floor,room:room,count:count,addtime:addtime,code:code,description:description,image:imageurl},
				    	    success:function(res){
				    			if(res.code=='0'){
				    				 layer.alert('修改成功')
				    				 layer.close(index);
				    					  
				    			   }else{
				    				 layer.alert('未能够成功修改')
				    			}
				    				  
				    		},
				    		error:function(res){
				    			layer.alert('出现错误');
				    	   }
				    	})
		        	},
		        	//创建层后需要的一些回调
		        	success:function(layero,index){
		        		
		        		//重新渲染
		        		form.render();
		        	},
		        	cancel:function(index){
						  layer.close(index);
						
					}
		        })
		    }
		  });
		//要先建立然后在弹出
		function edtior_edit(){
			layedit.set({
				 uploadImage:{
					 url:'/common/upload'//upload的接口
					 ,type:'post'
				 }
			 })
			 layuieditor= layedit.build('detail_LAY_demo1',{
				  tool:[
					  'strong' //加粗
					  ,'italic' //斜体
					  ,'underline' //下划线
					  ,'del' //删除线 
					  ,'|' //分割线
					  ,'left' //左对齐
					  ,'center' //居中对齐
					  ,'right' //右对齐
					  ,'link' //超链接
					  ,'unlink' //清除链接
					  ,'face' //表情
					  ,'image' //插入图片
					  ,'help' //帮助
			  		]
			  })
			  layuieditor= layedit.build('LAY_demo1',{
				  tool:[
					  'strong' //加粗
					  ,'italic' //斜体
					  ,'underline' //下划线
					  ,'del' //删除线 
					  ,'|' //分割线
					  ,'left' //左对齐
					  ,'center' //居中对齐
					  ,'right' //右对齐
					  ,'link' //超链接
					  ,'unlink' //清除链接
					  ,'face' //表情
					  ,'image' //插入图片
					  ,'help' //帮助
			  		]
			  })
			  
		}
	});
</script>
</body>

</html>