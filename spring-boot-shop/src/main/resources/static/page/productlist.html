<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <style>
        .layui-table-view {
            margin-top: 0;
            margin-bottom: 0;
        }
        .layui-table-view .layui-form-select .layui-input {
            height: 30px;
        }
        .layui-table-view .layui-form-select dl dd, .layui-form-select dl dt {
            line-height: 30px;
        }
        .layui-table-view .layui-form-select dl {
            top: 34px;
        }
        .layui-anim, .layui-anim-upbit, .layui-form-select dl {
            z-index: 10002;
        }
    </style>
</head>
<body class="layui-layout-body">
<table id="list" lay-filter="listtable"></table>
<script type="text/html" id="toswitch">
    <input type="checkbox" lay-skin="switch" lay-text="启用|禁用" {{d.status =='0'?"checked":"" }}>
</script>
</body>
<table id="comment" lay-filter="commentlisttable"></table>
<div id="divadd" style="display: none; padding: 10px">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">标题</label>
            <div class="layui-input-block">
                <input type="text" id="add-title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">内容简介</label>
            <div class="layui-input-block">
                <input type="text" id="add-summary" lay-verify="summary" autocomplete="off" placeholder="请输入简介" class="layui-input">

            </div>
        </div>
        <div class="layui-form-item">
            <lable class="layui-form-label">封面</lable>
            <div class="layui-upload" id="addimg">
                <button type="button" class="layui-btn" id="uppimg">上传封面图片</button>
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="uppimgview">
                    <p id="uppimgtext"></p>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
        	<div class="layui-inline">
                <label class="layui-form-label">所属分类</label>
                <div class="layui-input-inline">
                    <select id="add-type">
                        <option value="">请选择分类</option>
                    </select>
                </div>
            </div>
        <div class="layui-inline">
                <label class="layui-form-label">所属类型</label>
                <div class="layui-input-inline">
                    <select id="add-cate">
                        <option value="-1">请选择类型</option>
                    </select>
                </div>
            </div>
     
        	
        </div>
         <div class="layui-form-item">
            <label class="layui-form-label">内容</label>
            <div class="layui-input-block">
                <div id="content"></div>
            </div>
        </div>
    </form>
</div>
<script src="../layui/layui.js"></script>
<script src="../js/wangEditor.min.js"></script>
<script type="text/html" id="zizeng">
    {{d.LAY_TABLE_INDEX+1}}
</script>
<script type="text/html" id="img">
    <img src="http://10.33.8.51:92/{{d.cover}}" style="height: 100%; width: 100%">
</script>
<script type="text/html" id="typename">
    {{#  if(d.typeid==1){ }}
    养生
    {{#  } else if(d.typeid==2) { }}
    饮食
    {{#  }else if(d.typeid==3){ }}
    时政
    {{# }else if(d.typeid==4){ }}
    健康小贴士
    {{# }else if(d.typeid==5){ }}
    用品推荐
    {{# }else{  }}
    测试
    {{# }}}
</script>
<script type="text/html" id="authorname">

</script>
<script type="text/html" id="toolbarDemo">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item" style="margin-bottom: 0">
            <div class="layui-inline">
                <button lay-event="add" type="button" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe654;</i></button>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="height: 30px; line-height: 13px">起始日期</label>
                <div class="layui-input-inline" style="width: 95px;">
                    <input  type="text" style="height: 30px" id="startDate" placeholder="请选择日期" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="height: 30px; line-height: 13px">结束日期</label>
                <div class="layui-input-inline" style="width: 95px;">
                    <input type="text" style="height: 30px;" id="endDate" placeholder="请选择日期" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline" style="width: 100px">
                    <select id="sort" name="sort">
                        <option value="0">日期降序</option>
                        <option value="1">日期升序</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-input-inline" style="width: 110px">
                    <input id="key" type="text" style="height: 30px" placeholder="请输入关键字" class="layui-input layui-input-xs">
                </div>
                <button id="search" lay-event="search" class="layui-btn  layui-btn-sm" type="button"><i class="layui-icon">&#xe615;</i></button>
                <button id="refresh" lay-event="refresh" class="layui-btn  layui-btn-sm" type="button"><i class="layui-icon">&#xe669;</i></button>

            </div>
            <div class="layui-inline">
                <div class="layui-input-inline" style="width:100px">
                <select id="typesort">
                    <option value="0">请选择类型查看列表</option>
                </select>
                </div>
            </div>
            <div class="layui-inline" style="float: right">
                <button lay-event="delete" type="button" class="layui-btn layui-btn-danger layui-btn-sm"><i class="layui-icon">&#xe640;</i></button>
            </div>
        </div>
    </form>
</script>
<script type="text/html" id="barDemo">
    <div class="layui-inline">
        <a class="layui-btn layui-btn-xs" lay-event="edit">
            编辑
        </a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">
            删除
        </a>
        <a class="layui-btn layui-btn-xs" layui-event="showcomment">
            查看评论  	
        </a>
    </div>
</script>
<script>
    layui.use(['element', 'jquery', 'table', 'form', 'laydate', 'layer','upload'], function() {
        var element = layui.element;
        var $ = layui.jquery;
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var upload=layui.upload;
        var layer = layui.layer;

        var editor;
        editor = new wangEditor('#content');
        editor.customConfig.debug = true;
        editor.customConfig.uploadFileName = 'file';
        editor.customConfig.uploadImgServer = 'http://10.33.8.51:92/api/common/pic/s/upload';
       	//自定义上传图片事件
        editor.customConfig.uploadImgHooks = {
            before: function(xhr, editor, files) {
 
            },
            success: function(xhr, editor, result) {
                console.log("上传成功");
            },
            fail: function(xhr, editor, result) {
                console.log("上传失败,原因是" + result);
            },
            error: function(xhr, editor) {
                console.log("上传出错");
            },
            timeout: function(xhr, editor) {
                console.log("上传超时");
            },
             customInsert: function (insertImg, result, editor) {
        // 图片上传并返回结果，自定义插入图片的事件（而不是编辑器自动插入图片！！！）
        // insertImg 是插入图片的函数，editor 是编辑器对象，result 是服务器端返回的结果

        // 举例：假如上传图片成功后，服务器端返回的是 {url:'....'} 这种格式，即可这样插入图片：
        	var url = result.data[0];
        	console.log(url);
        	insertImg("http://10.33.8.51:92"+url);

        	// result 必须是一个 JSON 格式字符串！！！否则报错
    	}
        }
        editor.create();
		laydate.render({
			elem:'#addtime',
			type:'datetime'
		});
        table.render({
            elem: '#list',
            url: 'http://10.33.8.51:91/api/news/content/list',
            height: 'full-0',
            toolbar: '#toolbarDemo',
            id: '#listtable',
            page: true,
            where:{typeid:"1"},
            cols: [[
                {type:'checkbox', fixed: 'left'},
                {width: 40, title: '序号',fixed: 'left',templet:'#zizeng', type: 'numbers'},
                {field: 'title', title: '标题',width:60},
                {field: 'authorid', title: '作者',width:60},
                {field: 'categoryid', title: '所属分类', templet:'#catename',width:80},
                {field: 'typeid', title: '所属类型', templet:'#typename',width:80},
                {field: 'summary', title: '内容简介', width:120},
                {field: 'content', title: '内容',width:160},
                {field: 'cover',title:'封面', templet:'#img',width:160},
                {field: 'viewsum',title:'浏览数',width:120},
                {field: 'up',title:'点赞数',width:80},
                {field: 'down',title:'踩数',width:80},
                {field: 'time',title:'发布时间',width:120},
                {field: 'ip',title:'发布ip',width:120},
                {field: 'status',title:'状态',width:80,templet:'#toswitch'},
                {fixed: 'right', width:220, align:'center', toolbar: '#barDemo'}
            ]],
            done: function() {
                selecttypereset();
            }
        });

        function addreset() {//添加层元素初始化
            $('#add-name').val('');
            $("#add-cate").find("option:selected").text("");
            $("#add-cate").empty();
            $("#add-cate").append('<option value="">请选择类别</option>');
            $("#add-viewsum").val('');
            $("#add-title").val('');
            $("#add-down").val('');
            $("#add-summary").val('');
            $("#add-up").val('');
            editor.txt.html('');
            $('#addimg').empty();
            $('#addimg').append('<button type="button" class="layui-btn" id="uppimg">上传封面图片</button>\n' +
                '                <div class="layui-upload-list">\n' +
                '                    <img class="layui-upload-img" id="uppimgview" width="92" height="92" style="margin-left: 110px">\n' +
                '                    <p id="uppimgtext" style="margin-left: 110px"></p>\n' +
                '                </div>');
        }
        //头部获取下拉框
        function selecttypereset(){
            $.ajax({
                url:'http://10.33.8.51:91/api/news/type/list/all',
                method:'get',
                dataType:'json',
                success:function(res) {

                    if (res.code=="0"){
                        $newstype=$("#typesort");
                        console.log($newstype);
                        for (var i = 0; i < res.data.length; i++) {
                            $newstype.append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                        }
                        form.render();
                    }
                },
                error:function (res) {
                    layer.alert('出现错误');

                }
            })
        }
        function detailreset() {
        	$('#addimg').empty();
            $('#addimg').append(
                '                <div class="layui-upload-list">\n' +
                '                    <img class="layui-upload-img" id="uppimgview" width="92" height="92" style="margin-left: 110px">\n' +
                '                    <p id="uppimgtext" style="margin-left: 110px"></p>\n' +
                '                </div>');
        }


        function getKeyObj() {
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();
            var sort = $('#sort').val();
            var key = $('#key').val();
            return {
                startDate: startDate,
                endDate: endDate,
                sort: sort,
                key: key
            }
        }

        function setKeyObj(keyObj) {
            $('#startDate').val(keyObj.startDate);
            $('#endDate').val(keyObj.endDate);
            $('#sort').val(keyObj.sort);
            $('#key').val(keyObj.key);

            form.render();
        }

        function tablereload(page, keyObj) {
            table.reload('listtable', {
                page: page,
                where: keyObj,
                done: function() {
                    daterender();
                    setKeyObj(keyObj);
                }
            });
        }

        function getids(obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            if (checkStatus.data.length == 0) {
                layer.msg('没有选中行', {icon: 2, time: 500});
                return;
            }
            //提取oids
            var ids = [];
            for (var i = 0; i < checkStatus.data.length; i++)
                ids.push(checkStatus.data[i].id);
            return ids;
        }
        //判断浏览器大小方法
        function screen() {
            //获取当前窗口的宽度
            var width = $(window).width();
            if (width > 1200) {
                return 3;   //大屏幕
            } else if (width > 992) {
                return 2;   //中屏幕
            } else if (width > 768) {
                return 1;   //小屏幕
            } else {
                return 0;   //超小屏幕
            }
        }

        //监听头部工具栏
        table.on('toolbar(listtable)', function(obj){
            switch(obj.event){
                case 'add':
                    addreset();
                    var pimgurl = '';
                    var uploadInst = upload.render({
                        elem: '#uppimg',
                        url: 'http://10.33.8.51:92/api/common/pic/s/upload',
                        type:'post',
                        before: function(obj) {
                            obj.preview(function(index, file, res){
                                $('#uppimgview').attr('src', res); //图片链接（base64）
                                console.log(res);
                            });
                        },
                        done: function(res) {
                            if (res.errno =='0') {
                                pimgurl = res.data;
                                console.log("::"+res.data);
                            } else if (res.errno == '1') {
                                layer.msg(res.msg, {icon: 2, time: 1000});
                                return;
                            }
                        },
                        error: function() {
                            var demoText = $('#uppimgtext');
                            demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                            demoText.find('.demo-reload').on('click', function(){
                                uploadInst.upload();
                            });
                        }
                    });
                    layer.open({
                        type: 1,
                        content: $('#divadd'),
                        area: screen()<2?['85%','90%']:['1200px','600px'],
                        title: '添加资讯',
                        btn: ['添加'],
                        success: function(layero, index) {
                            $.ajax({
                                url: 'http://10.33.8.51:91/api/news/type/list/all',
                                type: 'get',
                                dataType: 'json',
                                success: function(res) {
                                    if (res.code == "0") {
                                        
                                        for (var i = 0; i < res.data.length; i++) {
                                           $('#add-type').append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                        }
                                        form.render();
                                    } else {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });
                            //分类名
                            $.ajax({
                                url: 'http://10.33.8.51:91/api/news/cate/list/all?typeid=1&pid=-1&rec=1&isSub=0',
                                type: 'get',
                                dataType: 'json',
                                success: function(res) {
                                    if (res.code == "0") {
                                        for (var i = 0; i < res.data.length; i++) {
                                           $('#add-cate').append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                        }
                                        form.render();
                                    } else {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });
                        },
                        yes: function(index) {
                       			
                            var title=$('#add-title').val();
                            var summary=$('#add-summary').val();
                            var pimg=$('#uppimg').val();
                            var type=$('#add-type').val();
                        
                            var cate = $('#add-cate').val();
                            var viewsum=$('#add-viewsum').val();
                            var up=$('#add-up').val();
                            var down=$('#add-down').val();
                            var content = editor.txt.html();
							console.log(content);
                            if (title == '') {
                                layer.msg('标题不能为空', {icon: 2, time: 1000});
                                $('#add-name').focus();
                                return;
                            }
                            
                            console.log("上传的路径"+pimgurl);
                            //提交表单
                            $.ajax({
                                url: 'http://10.33.8.51:91/api/news/content/add',
                                type: 'post',
                                data: {title:title,summary:summary,type:type,categoryid:cate,content:content,cover:pimgurl},
                                dataType: 'json',
                                success: function(res) {
                                    if (res.code == "0") {
                                        layer.msg('添加成功', {icon: 1, time: 500}, function() {
                                            $('#refresh').click();
                                            layer.close(index);
                                        });
                                    } else {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('网络错误', {icon: 2, time: 1000});
                                }
                            })
                        }
                    });
                    break;
                case 'search':
                    var keyObj = getKeyObj();
                    console.log(keyObj);
                    tablereload({curr: 1}, keyObj);
                    break;
                case 'refresh':
                    var keyObj = getKeyObj();
                    tablereload({curr: obj.config.page.curr}, keyObj);
                    break;
                case 'delete':
                    var ids = getids(obj);
                    if (ids.length == 0)
                        return;
                    layer.confirm('您确定要删除这' + ids.length + '条新闻吗？',
                        {btn: ['确定','取消'] },
                        function() {
                            $.ajax({
                                url: "http://10.33.8.51:92/api/news/content/delete",
                                type: 'post',
                                data: {id: ids},
                                dataType: 'json',
                                success: function (res) {
                                    if (res.code == '0') {
                                        layer.msg('删除成功', {icon: 1, time: 500}, function () {
                                            $('#refresh').click();
                                            layer.close(index);
                                        });
                                    } else if (res.code == '1') {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });
                        });
                    break;
            };
        });

        //监听行双击事件
        table.on('rowDouble(listtable)', function(obj) {
            detailreset();
            var data = obj.data;
            layer.open({
                type: 1,
                content: $('#divadd'),
                area: screen()<2?['85%','90%']:['1200px','600px'],
                title: '资讯详情',
                success: function(layero, index) {
                    $('#add-name').val(data.name);
                    $("#add-cate").val(data.categoryid);
                    $('#add-type').val(data.type);
                    $("#add-viewsum").val(data.viewsum);
                    $("#add-title").val(data.title);
                    $("#add-down").val(data.down);
                    $("#add-summary").val(data.summary);
                    $("#add-up").val(data.up);
                    $('#addtime').val(data.time);
                    $('#uppimgview').attr("src",'http://10.33.8.51:92/'+data.cover);
                   editor.txt.html(data.content);
                }
            });
            //标注选中样式
            obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
        });

        //监听工具条
        table.on('tool(listtable)', function(obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
               
            } else if (obj.event === 'edit') {
                addreset();
                layer.open({
                    type: 1,
                    content: $('#divadd'),
                    area: screen()<2?['85%','90%']:['1200px','600px'],
                    title: '编辑新闻',
                    btn: ['修改'],
                    success: function(layero, index) {
	                    $("#add-viewsum").val(data.viewsum);
	                    $("#add-title").val(data.title);
	                    $("#add-down").val(data.down);
	                    $("#add-summary").val(data.summary);
	                    $("#add-up").val(data.up);
	                    $("#add-ip").val(data.ip); 
	                    $('#addtime').val(data.time);
	                    $('#uppimgview').attr("src",'http://10.33.8.51:92/'+data.cover);
	                    editor.txt.html(data.content);
                        //获取类型列表
                         $.ajax({
                                url: 'http://10.33.8.51:91/api/news/type/list/all',
                                type: 'get',
                                dataType: 'json',
                                success: function(res) {
                                    if (res.code == "0") {
                                        
                                        for (var i = 0; i < res.data.length; i++) {
                                           $('#add-type').append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                        }
                                        form.render();
                                    } else {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });
                            //分类名
                            $.ajax({
                                url: 'http://10.33.8.51:91/api/news/cate/list/all?typeid=1&pid=-1&rec=1&isSub=0',
                                type: 'get',
                                dataType: 'json',
                                success: function(res) {
                                    if (res.code == "0") {
                                        for (var i = 0; i < res.data.length; i++) {
                                           $('#add-cate').append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                        }
                                        form.render();
                                    } else {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });
					 var pimgurl = '';
                    var uploadInst = upload.render({
                        elem: '#uppimg',
                        url: 'http://10.33.8.51:92/api/common/pic/s/upload',
                        type:'post',
                        before: function(obj) {
                            obj.preview(function(index, file, res){
                                $('#uppimgview').attr('src', 'http://10.33.8.51:92/'+res.data[0]); //图片链接（base64）
                            });
                        },
                        done: function(res) {
                            if (res.code =='0') {
                                pimgurl = res.data[0];
                                console.log("::"+res.data[0]);
                            } else if (res.code == '1') {
                                layer.msg(res.msg, {icon: 2, time: 1000});
                                return;
                            }
                        },
                        error: function() {
                            var demoText = $('#uppimgtext');
                            demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                            demoText.find('.demo-reload').on('click', function(){
                                uploadInst.upload();
                            });
                        }
                    });
                    
                       

                    },
                    yes: function(index) {
                        	var title=$('#add-title').val();
                            var summary=$('#add-summary').val();
                            var pimg=$('#uppimgview').val();
                            console.log(pimg);
                            var type=$('#add-type').val();
                        	var status=$('#add-stauts').val();
                            var cate = $('#add-cate').val();
                            var viewsum=$('#add-viewsum').val();
                            var content = editor.txt.html();
                            
                        	var authorid=1;

                        if (title == '') {
                            layer.msg('新闻名称不能为空', {icon: 2, time: 1000});
                            $('#add-title').focus();
                            return;
                        }

                        $.ajax({
                            url: 'http://10.33.8.51:91/api/mews/content/update',
                            type: 'post',
                            data: {id: data.id, title:title, authorid:authorid,categoryid:cate, summary:summary,content:content,cover:pimg,status:status},
                            dataType: 'json',
                            success: function(res) {
                                if (res.code == "0") {
                                    layer.msg('添加成功', {icon: 1, time: 500}, function() {
                                        $('#refresh').click();
                                        layer.close(index);
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 2, time: 1000});
                                }
                            },
                            error: function(res) {
                                layer.msg('网络错误', {icon: 2, time: 1000});
                            }
                        })
                    }
                });
            } else if (obj.event === 'delete') {
            			var id=data.id;
                            $.ajax({
                                url: "http://10.33.8.51:91/api/news/content/delete/"+id,
                                type: 'post',
                                dataType: 'json',
                                success: function (res) {
                                    if (res.code == '0') {
                                        layer.msg('删除成功', {icon: 1, time: 500}, function () {
                                            $('#refresh').click();
                                            layer.close(index);
                                        });
                                    } else if (res.code == '1') {
                                        layer.msg(res.msg, {icon: 2, time: 1000});
                                    }
                                },
                                error: function(res) {
                                    layer.msg('异常错误', {icon: 2, time: 1000});
                                }
                            });	
            }else if(obj.event==='showcomment'){
            	layer.open({
                        type: 1,
                        content: $('#comment'),
                        area: screen()<2?['85%','90%']:['1200px','600px'],
                        title: '资讯评论列表',
                        success: function(layero, index) {
                            
                        },
                        yes: function(index) {
                       			
                            
                           
                        }
                    });
            	
            }
        });


    });
</script>
</html>















