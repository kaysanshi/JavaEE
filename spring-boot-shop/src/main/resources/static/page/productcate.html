<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../layui/lay/modules/treetable-lay/treetable.css" />
    <style>
        .layui-table-view {
            margin-top: 0;
            margin-bottom: 0;
        }
        .layui-table-view .layui-form-select .layui-input {
            height: 30px;
        }
        .layui-table-view .layui-form-select dl dd, .layui-form-select dl dt {
            line-height: 30px;
        }
        .layui-table-view .layui-form-select dl {
            top: 34px;
        }
        .layui-anim, .layui-anim-upbit, .layui-form-select dl {
            z-index: 10002;
        }
    </style>
</head>
<body class="layui-layout-body">
<table id="list" lay-filter="listtable"></table>
</body>
<div id="divadd" style="display: none; padding: 10px">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <label class="layui-form-label">分类名称</label>
            <div class="layui-input-inline">
                <input type="text" id="add-name" required lay-verify="required" autocomplete="off" placeholder="请输入分类名" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属类型</label>
            <div class="layui-input-inline">
                <select id="add-newstype">
                    <option value="-1">无</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
        	 <label class="layui-form-label">是否启用</label>
        	 <div class="layui-input-block">
		      	<input type="checkbox" name="switch" id="add-status"lay-skin="switch">
		    </div>
        </div>
    </form>
</div>
<script src="../layui/layui.js"></script>
<script src="../layui/lay/modules/treetable-lay/treetable.js"></script>
<script src="../js/wangEditor.min.js"></script>
<script type="text/html" id="zizeng">
    {{d.LAY_TABLE_INDEX+1}}
</script>
<script type="text/html" id="toswitch">
    <input type="checkbox" lay-skin="switch" lay-text="启用|禁用" {{d.status =='0'?"checked":"" }}>
</script>
<script type="text/html" id="typename">
    {{#  if(d.typeid==1){ }}
        养生
    {{#  } else if(d.typeid==2) { }}
        饮食
    {{#  }else if(d.typeid==3){ }}
        时政
    {{# }else if(d.typeid==4){ }}
        健康小贴士
    {{# }else if(d.typeid==5){ }}
        用品推荐
    {{# }else{  }}
        测试
    {{# }}}
</script>
<script type="text/html" id="toolbarDemo">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item" style="margin-bottom: 0">

            <div class="layui-inline">
                <button lay-event="add" type="button" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe654;</i></button>
                <button id="refresh" lay-event="refresh" class="layui-btn  layui-btn-sm" type="button"><i class="layui-icon">&#xe669;</i></button>
            </div>
            <div class="layui-inline" style="float: right">
                <button lay-event="delete" type="button" class="layui-btn layui-btn-danger layui-btn-sm"><i class="layui-icon">&#xe640;</i></button>
            </div>
            
        </div>
    </form>
</script>

<script type="text/html" id="barDemo">
    <div class="layui-inline">
          <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="showtree">
       	 展开
        </a>
          <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="closetree">
     	关闭
        </a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">
            编辑
        </a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="addtree">
            添加字节点
        </a>
    </div>
</script>
<script>
	layui.config({
		base:'/static/layui/lay/modules/'
	}).extend({
		treetable:'treetable-lay/treetable'
	});
    layui.use(['element', 'jquery', 'table', 'form', 'laydate', 'layer','treetable'], function() {
        var element = layui.element;
        var $ = layui.jquery;
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var layer = layui.layer;
		var treetable=layui.treetable;

        function daterender() {
            laydate.render({
                elem: '#startDate',
                format:'yyyy-MM-dd'
            });
            laydate.render({
                elem: '#endDate',
                format:'yyyy-MM-dd'
            });
        }
		treetable.render({
			treeColIndex:3,
			treeSpid:-1,
			treeIdName:'id',
			treePidName:'pid',
			treeDefaultClose:false,//默认全部关闭，这里打开
			treeLinkage:true,
			elem:'#list',
			url:'http://10.33.8.51:91/api/news/cate/list/all?typeid=1&pid=-1&rec=1&isSub=0',
		
			//url:'http://127.0.0.1:8020/static/json/test.json',
			cols:[[
				{type:'checkbox', fixed: 'left'},
                {width: 60, title: '序号',fixed: 'left',templet:'#zizeng', type: 'numbers'},
				{field:'pid',title:'pid', width:50,style:'display:none;'},
				{field:'name', title:'分类名称'},
				{field:'typeid',title:'类型名称',width:120,templet:'#typename'},
				{field:'status',title:'状态', width:90,templet:'#toswitch'},
				{fixed: 'right', align:'left', toolbar: '#barDemo'},
			]],
			done:function(){
				$('table:eq(1).layui-table thead tr th:eq(0)').addClass('layui-hide');
			}
			
		});
//      table.render({
//          elem: '#list',
//          url: 'http://10.33.8.51:91/api/news/cate/list/all?typeid=1&pid=-1&rec=0',
//          height: 'full-0',
//          toolbar: '#toolbarDemo',
//          id: '#listtable',
//          page: true,
//          cols: [[
//              {type:'checkbox', fixed: 'left'},
//              {width: 60, title: '序号',fixed: 'left',templet:'#zizeng', type: 'numbers'},
//              {field: 'name', title: '父级分类名称'},
//              {field:'typid',title:'所属类型',templet:'#typename'},
//              {field:'status', title:'状态' , width:80 ,templet:'#toswitch'},
//              {fixed: 'right', align:'left', toolbar: '#barDemo'}
//          ]],
//          done:function () {
//
//          }
//      });

        function addreset() {//添加层元素初始化
            $('#add-name').val('');
            $("#add-newscate").find("option:selected").text("");
            $("#add-newscate").empty();
            $("#add-newscate").append('<option value="">请选择类别</option>');
        }


        function getKeyObj() {
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();
            var sort = $('#sort').val();
            var key = $('#key').val();
            return {
                startDate: startDate,
                endDate: endDate,
                sort: sort,
                key: key
            }
        }

        function setKeyObj(keyObj) {
            $('#startDate').val(keyObj.startDate);
            $('#endDate').val(keyObj.endDate);
            $('#sort').val(keyObj.sort);
            $('#key').val(keyObj.key);

            form.render();
        }

        function tablereload(page, keyObj) {
            table.reload('listtable', {
                page: page,
                where: keyObj,
                done: function() {
                    daterender();
                    setKeyObj(keyObj);
                }
            });
        }

        function getids(obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            if (checkStatus.data.length == 0) {
                layer.msg('没有选中行', {icon: 2, time: 500});
                return;
            }
            //提取oids
            var ids = [];
            for (var i = 0; i < checkStatus.data.length; i++)
                ids.push(checkStatus.data[i].id);
            return ids;
        }
        //判断浏览器大小方法
        function screen() {
            //获取当前窗口的宽度
            var width = $(window).width();
            if (width > 1200) {
                return 3;   //大屏幕
            } else if (width > 992) {
                return 2;   //中屏幕
            } else if (width > 768) {
                return 1;   //小屏幕
            } else {
                return 0;   //超小屏幕
            }
        }

        //监听头部工具栏
        table.on('toolbar(listtable)', function(obj){
            switch(obj.event){
                case 'showtree':
                   
                    break;
                case 'closetree':
                    
                    break;
                case 'refresh':
                    var keyObj = getKeyObj();
                    tablereload({curr: obj.config.page.curr}, keyObj);
                    break;
                case 'editor':

                    break;
                case 'addtree':
                addreset();
                layer.open({
                    type: 1,
                    content: $('#divadd'),
                    area: screen()<2?['80%','70%']:['1000px','600px'],
                    title: '添加字节点',
                    btn: ['确认'],
                    success: function(layero, index) {
                        //获取分类列表
                        $.ajax({
                            url: 'http://10.33.8.51:91/api/news/type/list',
                            type: 'post',
                            dataType: 'json',
                            success: function(res) {
                                if (res.code == "0") {
                                    var $newstype = $('#add-newstype');
                                    for (var i = 0; i < res.count; i++) {
                                        $newstype.append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                    }
                                    form.render();
                                } else {
                                    layer.msg(res.msg, {icon: 2, time: 1000});
                                }
                            },
                            error: function(res) {
                                layer.msg('异常错误', {icon: 2, time: 1000});
                            }
                        });


                    },
                    yes: function(index) {
                        var typeid = $('#add-newstype').val();
                        var pid=data.pid;
                        var name=$('#add-name').val();
						var status=$('#add-status').val();
                      
                        if (typeid == '') {
                            layer.msg('请选择新闻分类', {icon: 2, time: 1000});
                            return;
                        }

                        $.ajax({
                            url: 'http://10.33.8.51:91/api/news/cate/list/add',
                            type: 'post',
                            data: {id: data.id, pid:pid,type:typeid,name:name,status:status},
                            dataType: 'json',
                            success: function(res) {
                                if (res.code == "0") {
                                    layer.msg('添加成功', {icon: 1, time: 500}, function() {
                                        $('#refresh').click();
                                        layer.close(index);
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 2, time: 1000});
                                }
                            },
                            error: function(res) {
                                layer.msg('网络错误', {icon: 2, time: 1000});
                            }
                        })
                    }
                });
            };
        });



        //监听工具条
        table.on('tool(listtable)', function(obj) {
            var data = obj.data;
            if (obj.event === 'edit') {
                addreset();
                layer.open({
                    type: 1,
                    content: $('#divadd'),
                    area: screen()<2?['80%','70%']:['1000px','600px'],
                    title: '编辑新闻分类',
                    btn: ['修改'],
                    success: function(layero, index) {
                        //获取分类列表
                        $.ajax({
                            url: '/n/nquery',
                            type: 'post',
                            dataType: 'json',
                            success: function(res) {
                                if (res.code == "0") {
                                    var $cate = $('#add-cate');
                                    for (var i = 0; i < res.count; i++) {
                                        $cate.append('<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>')
                                    }

                                    //参数传递
                                    $('#add-name').val(data.title);
                                    $('#add-cate').val(data.ncid);
                                    editor.txt.html(data.detail);

                                    form.render();
                                } else {
                                    layer.msg(res.msg, {icon: 2, time: 1000});
                                }
                            },
                            error: function(res) {
                                layer.msg('异常错误', {icon: 2, time: 1000});
                            }
                        });


                    },
                    yes: function(index) {
                        var name = $('#add-name').val();
                        var cate = $('#add-cate').val();
                        var detail = editor.txt.html();

                        if (name == '') {
                            layer.msg('新闻分类名称不能为空', {icon: 2, time: 1000});
                            $('#add-name').focus();
                            return;
                        }
                        if (cate == '') {
                            layer.msg('请选择新闻分类', {icon: 2, time: 1000});
                            return;
                        }

                        $.ajax({
                            url: '/p/update',
                            type: 'post',
                            data: {id: data.id, title: name, ncid: cate, detail: detail},
                            dataType: 'json',
                            success: function(res) {
                                if (res.code == "0") {
                                    layer.msg('添加成功', {icon: 1, time: 500}, function() {
                                        $('#refresh').click();
                                        layer.close(index);
                                    });
                                } else {
                                    layer.msg(res.msg, {icon: 2, time: 1000});
                                }
                            },
                            error: function(res) {
                                layer.msg('网络错误', {icon: 2, time: 1000});
                            }
                        })
                    }
                });
            } else if (obj.event === 'delete') {
                $('#addtree').attr("disable",false);
                layer.open({
                    type:1,
                    title:'展示所有分类树',
                    maxmin:true,
                    area:['450px','500px'],
                    shade:0,
                    content:$("#showtree")

                });
                var zTreeObj;
                var setting={

                }

            }

        });


    });
</script>
</html>















